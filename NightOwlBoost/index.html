<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>夜貓子補給站</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(-45deg, #111827, #1f2937, #374151, #4f46e5);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px #6366f1, 0 0 10px #6366f1; }
            50% { box-shadow: 0 0 20px #818cf8, 0 0 30px #818cf8; }
            100% { box-shadow: 0 0 5px #6366f1, 0 0 10px #6366f1; }
        }

        .tab-btn.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            animation: glow 2s infinite ease-in-out;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        #roulette-wheel {
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        #breathing-circle {
            transition: transform 4s ease-in-out, background-color 4s ease-in-out, box-shadow 1s ease-in-out;
        }
        #breathing-circle:hover {
            box-shadow: 0 0 25px #0ea5e9;
        }
        
        /* Custom Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1f2937; /* gray-800 */
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s;
            width: 90%;
            max-width: 400px;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="text-gray-200 min-h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-3xl mx-auto bg-gray-800/80 backdrop-blur-sm rounded-2xl shadow-2xl p-6 md:p-8 border border-gray-700/50">
        
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-700">
            <div class="flex items-center mb-4 sm:mb-0">
                <img src="https://sdmntprwestus2.oaiusercontent.com/files/00000000-6500-61f8-86fb-54f8f8012b82/raw?se=2025-07-25T10%3A23%3A27Z&sp=r&sv=2024-08-04&sr=b&scid=36769a53-d3f6-53e1-bc80-1e6083e4ee05&skoid=b0fd38cc-3d33-418f-920e-4798de4acdd1&sktid=a48cca56-e6da-484e-a814-9c849652bcb3&skt=2025-07-24T22%3A16%3A54Z&ske=2025-07-25T22%3A16%3A54Z&sks=b&skv=2024-08-04&sig=VHo4frbdAV%2B/DAM61x7hRb/vl/G4fU4ChpW0KMnvgk0%3D" alt="夜貓子補給站 LOGO" class="h-16 w-16 mr-4 rounded-full object-cover">
                <!-- MODIFIED: Added subtitles -->
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-white">夜貓子補給站</h1>
                    <p class="text-sm text-indigo-300 mt-1">NightOwl Boost</p>
                    <p class="text-xs text-gray-400 mt-2">撐過黑夜，就能發光！</p>
                </div>
            </div>
            <div id="clock" class="text-lg font-mono text-indigo-300">--:--:--</div>
        </header>

        <!-- Tabs -->
        <div class="mb-6">
            <div class="flex flex-wrap justify-center gap-2 sm:gap-4">
                <button data-tab="music" class="tab-btn active px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:bg-indigo-500 hover:scale-105">舒壓音樂</button>
                <button data-tab="game" class="tab-btn px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:bg-indigo-500 hover:scale-105">趣味遊戲</button>
                <button data-tab="roulette" class="tab-btn px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:bg-indigo-500 hover:scale-105">宵夜輪盤</button>
                <button data-tab="breathing" class="tab-btn px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:bg-indigo-500 hover:scale-105">靜心一隅</button>
            </div>
        </div>

        <!-- Content Panels -->
        <main>
            <!-- Music Panel -->
            <div id="music-content" class="tab-content active text-center">
                <h2 class="text-xl font-bold mb-4 text-indigo-400">Lofi 氛圍音樂</h2>
                <p class="mb-6 text-gray-400">點擊下方按鈕，沉浸在放鬆的 Lofi 節拍中。</p>
                <div id="music-controls" class="flex flex-wrap justify-center gap-4">
                    <button id="music-btn" class="bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-110">播放</button>
                </div>
                <p id="music-status" class="mt-4 text-sm text-gray-500">狀態：待機中</p>
            </div>

            <!-- Game Panel -->
            <div id="game-content" class="tab-content text-center">
                <h2 class="text-xl font-bold mb-4 text-indigo-400">經典貪食蛇</h2>
                <div class="bg-gray-900 p-2 rounded-lg inline-block">
                    <canvas id="snake-canvas" width="320" height="320" class="bg-gray-700 rounded"></canvas>
                </div>
                <div class="mt-4 flex justify-center items-center gap-6">
                    <button id="start-game-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">開始遊戲</button>
                    <div class="text-lg">分數: <span id="score">0</span></div>
                </div>
                 <p class="mt-2 text-sm text-gray-500">使用方向鍵或在遊戲區滑動來控制方向</p>
            </div>

            <!-- Roulette Panel -->
            <div id="roulette-content" class="tab-content text-center">
                <h2 class="text-xl font-bold mb-4 text-indigo-400">今晚宵夜吃什麼？</h2>
                <div class="relative w-64 h-64 sm:w-80 sm:h-80 mx-auto mb-6 flex items-center justify-center">
                    <div id="roulette-wheel" class="w-full h-full rounded-full border-4 border-indigo-500 relative overflow-hidden"></div>
                    <div class="absolute w-8 h-8 bg-white rounded-full border-4 border-indigo-500 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-10"></div>
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-2 text-4xl text-indigo-300 animate-bounce z-10">▼</div>
                </div>
                <div class="flex justify-center gap-4">
                    <button id="spin-btn" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-8 rounded-full text-lg transition-transform transform hover:scale-105">開轉！</button>
                    <button id="manage-options-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-full text-lg transition-transform transform hover:scale-105">管理品項</button>
                </div>
                <p id="roulette-result" class="mt-4 text-2xl font-bold h-8"></p>
            </div>

            <!-- Breathing Panel -->
            <div id="breathing-content" class="tab-content text-center">
                <h2 class="text-xl font-bold mb-4 text-indigo-400">4-7-8 呼吸法</h2>
                <p class="mb-6 text-gray-400">跟著圓圈的節奏，進行一次深呼吸，清空思緒。</p>
                <div class="w-48 h-48 mx-auto rounded-full bg-sky-700 flex items-center justify-center" id="breathing-circle">
                    <span id="breathing-text" class="text-white text-2xl font-bold">點我開始</span>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Game Over Modal -->
    <div id="game-over-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-white mb-2">遊戲結束！</h3>
            <p class="text-gray-300 mb-6">你的分數是: <span id="final-score" class="font-bold text-indigo-400">0</span></p>
            <button id="restart-game-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg transition-transform transform hover:scale-105">重新開始</button>
        </div>
    </div>
    
    <!-- Roulette Options Modal -->
    <div id="roulette-options-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-white mb-4">管理宵夜品項</h3>
            <div id="roulette-options-list" class="max-h-60 overflow-y-auto mb-4 text-left">
                <!-- Options list will be rendered here -->
            </div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="new-option-input" placeholder="新增宵夜..." class="flex-grow bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="add-option-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg">新增</button>
            </div>
            <button id="close-options-modal-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">完成</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Universal ---
            const clockElement = document.getElementById('clock');
            function updateClock() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                clockElement.textContent = `${hours}:${minutes}:${seconds}`;
            }
            setInterval(updateClock, 1000);
            updateClock();

            // --- Tab Logic ---
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const tab = button.dataset.tab;
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tab}-content`) {
                            content.classList.add('active');
                        }
                    });
                });
            });

            // --- Music Logic (Tone.js Lofi) ---
            const musicBtn = document.getElementById('music-btn');
            const musicStatus = document.getElementById('music-status');
            let isMusicInitialized = false;
            let isPlaying = false;
            let piano, bass;

            async function initializeMusic() {
                await Tone.start();
                const reverb = new Tone.Reverb(2).toDestination();
                const feedbackDelay = new Tone.FeedbackDelay("8n", 0.5).connect(reverb);
                piano = new Tone.PolySynth(Tone.FMSynth, { harmonicity: 3, modulationIndex: 10, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 1 }, modulation: { type: "sine" }, modulationEnvelope: { attack: 0.1, decay: 0.1, sustain: 0.5, release: 0.1 } }).connect(feedbackDelay);
                bass = new Tone.MonoSynth({ oscillator: { type: "fmsine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.4 } }).toDestination();
                const chords = [{ time: "0:0", notes: ["C4", "E4", "G4", "B4"], root: "C2" }, { time: "0:2", notes: ["F3", "A3", "C4", "E4"], root: "F2" }, { time: "1:0", notes: ["A3", "C4", "E4", "G4"], root: "A2" }, { time: "1:2", notes: ["G3", "B3", "D4", "F4"], root: "G2" }];
                new Tone.Part((time, value) => { piano.triggerAttackRelease(value.notes, "4n", time); bass.triggerAttackRelease(value.root, "4n", time); }, chords).start(0);
                Tone.Transport.loop = true;
                Tone.Transport.loopEnd = "2m";
                Tone.Transport.bpm.value = 80;
                isMusicInitialized = true;
            }

            musicBtn.addEventListener('click', async () => {
                if (!isMusicInitialized) { await initializeMusic(); }
                if (isPlaying) {
                    Tone.Transport.stop();
                    musicBtn.textContent = '播放';
                    musicStatus.textContent = '狀態：待機中';
                    musicBtn.classList.remove('bg-red-600', 'hover:bg-red-500');
                    musicBtn.classList.add('bg-teal-600', 'hover:bg-teal-500');
                    isPlaying = false;
                } else {
                    Tone.Transport.start();
                    musicBtn.textContent = '停止';
                    musicStatus.textContent = '狀態：播放中...';
                    musicBtn.classList.remove('bg-teal-600', 'hover:bg-teal-500');
                    musicBtn.classList.add('bg-red-600', 'hover:bg-red-500');
                    isPlaying = true;
                }
            });

            // --- Snake Game Logic ---
            const canvas = document.getElementById('snake-canvas');
            const ctx = canvas.getContext('2d');
            const startBtn = document.getElementById('start-game-btn');
            const scoreEl = document.getElementById('score');
            const gameOverModal = document.getElementById('game-over-modal');
            const finalScoreEl = document.getElementById('final-score');
            const restartBtn = document.getElementById('restart-game-btn');
            const gridSize = 20;
            const tileCount = canvas.width / gridSize;
            let snake, food, score, direction, gameInterval, touchStartX, touchStartY;
            function initGame() { snake = [{ x: 10, y: 10 }]; food = {}; placeFood(); score = 0; direction = 'right'; scoreEl.textContent = '0'; if (gameInterval) clearInterval(gameInterval); draw(); gameOverModal.classList.remove('visible'); }
            function placeFood() { food.x = Math.floor(Math.random() * tileCount); food.y = Math.floor(Math.random() * tileCount); for (let part of snake) { if (part.x === food.x && part.y === food.y) { placeFood(); return; } } }
            function draw() { ctx.fillStyle = '#374151'; ctx.fillRect(0, 0, canvas.width, canvas.height); for (let part of snake) { ctx.fillStyle = '#34d399'; ctx.fillRect(part.x * gridSize, part.y * gridSize, gridSize - 2, gridSize - 2); } ctx.fillStyle = '#f87171'; ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2); }
            function showGameOver() { clearInterval(gameInterval); finalScoreEl.textContent = score; gameOverModal.classList.add('visible'); }
            function gameLoop() { const head = { x: snake[0].x, y: snake[0].y }; switch (direction) { case 'up': head.y--; break; case 'down': head.y++; break; case 'left': head.x--; break; case 'right': head.x++; break; } if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount || checkCollision(head)) { showGameOver(); return; } snake.unshift(head); if (head.x === food.x && head.y === food.y) { score++; scoreEl.textContent = score; placeFood(); } else { snake.pop(); } draw(); }
            function checkCollision(head) { for (let i = 1; i < snake.length; i++) { if (head.x === snake[i].x && head.y === snake[i].y) return true; } return false; }
            startBtn.addEventListener('click', () => { if (gameInterval) clearInterval(gameInterval); initGame(); gameInterval = setInterval(gameLoop, 150); });
            restartBtn.addEventListener('click', () => { if (gameInterval) clearInterval(gameInterval); initGame(); gameInterval = setInterval(gameLoop, 150); });
            document.addEventListener('keydown', e => { switch (e.key) { case 'ArrowUp': if (direction !== 'down') direction = 'up'; break; case 'ArrowDown': if (direction !== 'up') direction = 'down'; break; case 'ArrowLeft': if (direction !== 'right') direction = 'left'; break; case 'ArrowRight': if (direction !== 'left') direction = 'right'; break; } });
            canvas.addEventListener('touchstart', e => { e.preventDefault(); touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; }, { passive: false });
            canvas.addEventListener('touchmove', e => { e.preventDefault(); if (!touchStartX || !touchStartY) return; let diffX = e.touches[0].clientX - touchStartX; let diffY = e.touches[0].clientY - touchStartY; if (Math.abs(diffX) > Math.abs(diffY)) { if (diffX > 0 && direction !== 'left') direction = 'right'; else if (diffX < 0 && direction !== 'right') direction = 'left'; } else { if (diffY > 0 && direction !== 'up') direction = 'down'; else if (diffY < 0 && direction !== 'down') direction = 'up'; } touchStartX = null; touchStartY = null; }, { passive: false });
            initGame();

            // --- Roulette Logic ---
            const wheel = document.getElementById('roulette-wheel');
            const spinBtn = document.getElementById('spin-btn');
            const resultEl = document.getElementById('roulette-result');
            const manageOptionsBtn = document.getElementById('manage-options-btn');
            const optionsModal = document.getElementById('roulette-options-modal');
            const optionsListEl = document.getElementById('roulette-options-list');
            const newOptionInput = document.getElementById('new-option-input');
            const addOptionBtn = document.getElementById('add-option-btn');
            const closeOptionsModalBtn = document.getElementById('close-options-modal-btn');
            
            let options = [];
            let currentRotation = 0;
            let isSpinning = false;

            function loadOptions() {
                const storedOptions = localStorage.getItem('rouletteOptions');
                if (storedOptions) {
                    options = JSON.parse(storedOptions);
                } else {
                    options = ["鹽酥雞", "泡麵", "關東煮", "雞排", "臭豆腐", "滷味", "水餃", "豆漿油條"];
                }
                if (options.length < 2) {
                    spinBtn.disabled = true;
                    spinBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    spinBtn.disabled = false;
                     spinBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            function saveOptions() {
                localStorage.setItem('rouletteOptions', JSON.stringify(options));
                 if (options.length < 2) {
                    spinBtn.disabled = true;
                    spinBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    spinBtn.disabled = false;
                     spinBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
            
            function setupRoulette() {
                wheel.innerHTML = '';
                if(options.length === 0) return;

                const numOptions = options.length;
                const segmentAngle = 360 / numOptions;
                const color1 = '#374151';
                const color2 = '#4b5563';
                let gradientParts = [];
                for (let i = 0; i < numOptions; i++) {
                    const color = i % 2 === 0 ? color1 : color2;
                    gradientParts.push(`${color} ${i * segmentAngle}deg ${(i + 1) * segmentAngle}deg`);
                }
                wheel.style.background = `conic-gradient(${gradientParts.join(', ')})`;

                options.forEach((option, i) => {
                    const textAngleDeg = (i * segmentAngle) + (segmentAngle / 2);
                    const textContainer = document.createElement('div');
                    textContainer.className = 'absolute top-0 left-0 w-full h-full';
                    textContainer.style.transform = `rotate(${textAngleDeg}deg)`;
                    const textDiv = document.createElement('div');
                    textDiv.className = 'text-white font-semibold text-sm';
                    textDiv.textContent = option;
                    textDiv.style.position = 'absolute';
                    textDiv.style.top = '15%';
                    textDiv.style.left = '50%';
                    textDiv.style.transform = 'translateX(-50%)';
                    textContainer.appendChild(textDiv);
                    wheel.appendChild(textContainer);
                });
            }
            
            function renderOptionsList() {
                optionsListEl.innerHTML = '';
                options.forEach((option, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between items-center bg-gray-700 p-2 rounded-lg mb-2';
                    itemEl.innerHTML = `
                        <span class="text-gray-300">${option}</span>
                        <button data-index="${index}" class="delete-option-btn text-red-400 hover:text-red-300 font-bold text-xl">&times;</button>
                    `;
                    optionsListEl.appendChild(itemEl);
                });
            }

            manageOptionsBtn.addEventListener('click', () => {
                renderOptionsList();
                optionsModal.classList.add('visible');
            });

            closeOptionsModalBtn.addEventListener('click', () => {
                optionsModal.classList.remove('visible');
            });

            addOptionBtn.addEventListener('click', () => {
                const newOption = newOptionInput.value.trim();
                if (newOption) {
                    options.push(newOption);
                    newOptionInput.value = '';
                    saveOptions();
                    setupRoulette();
                    renderOptionsList();
                }
            });
            
            newOptionInput.addEventListener('keypress', (e) => {
                if(e.key === 'Enter') {
                    addOptionBtn.click();
                }
            });

            optionsListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-option-btn')) {
                    const index = parseInt(e.target.dataset.index, 10);
                    options.splice(index, 1);
                    saveOptions();
                    setupRoulette();
                    renderOptionsList();
                }
            });

            spinBtn.addEventListener('click', () => {
                if (isSpinning || options.length < 2) return;
                isSpinning = true;
                resultEl.textContent = '';
                const randomSpins = Math.floor(Math.random() * 4) + 5;
                const randomStopAngle = Math.floor(Math.random() * 360);
                const totalRotation = randomSpins * 360 + randomStopAngle;
                currentRotation += totalRotation;
                wheel.style.transform = `rotate(${currentRotation}deg)`;

                setTimeout(() => {
                    const finalAngle = currentRotation % 360;
                    const segmentAngle = 360 / options.length;
                    const pointerOffset = 270;
                    const winningAngle = (finalAngle + pointerOffset) % 360;
                    const selectedIndex = Math.floor(winningAngle / segmentAngle);
                    resultEl.textContent = options[selectedIndex];
                    isSpinning = false;
                }, 5000);
            });
            
            // Initial Load
            loadOptions();
            setupRoulette();


            // --- Breathing Logic ---
            const circle = document.getElementById('breathing-circle');
            const text = document.getElementById('breathing-text');
            let isBreathing = false;
            circle.addEventListener('click', () => {
                if (isBreathing) return;
                isBreathing = true;
                function runSequence() {
                    text.textContent = '吸氣 (4s)';
                    circle.style.transform = 'scale(1.5)';
                    circle.style.backgroundColor = '#38bdf8';
                    setTimeout(() => {
                        text.textContent = '閉氣 (7s)';
                        circle.style.backgroundColor = '#818cf8';
                        setTimeout(() => {
                            text.textContent = '吐氣 (8s)';
                            circle.style.transform = 'scale(1)';
                            circle.style.backgroundColor = '#0369a1';
                            setTimeout(() => {
                                text.textContent = '點我開始';
                                isBreathing = false;
                            }, 8000);
                        }, 7000);
                    }, 4000);
                }
                runSequence();
            });
        });
    </script>
</body>
</html>
